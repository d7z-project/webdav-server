<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebDAV Server</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="layout-center">

<div class="container container-md">
    <div class="icon-box">☁️</div>
    <h1>简易文件服务器</h1>
    <p class="subtitle">Simple WebDAV & File Server</p>

    <a href="/preview/" class="btn btn-block">浏览文件 (Preview)</a>
    
    {{if .IsLogged }}
    <a href="/logout" class="btn btn-outline btn-block">注销 (Logout {{.User}})</a>
    {{else}}
    <a href="/login" class="btn btn-outline btn-block">登录 (Login)</a>
    {{end}}

    {{if .Config.Webdav.Enabled }}
    <div class="card-info">
        <h3>WebDAV</h3>
        <div class="info-group">
            <div class="info-label">连接地址</div>
            <div class="code-block">
                <span id="webdav-url">Loading...</span>
                <button class="copy-btn" onclick="copyToClipboard('webdav-url')">复制</button>
            </div>
        </div>
    </div>
    {{end}}

    {{if .Config.SFTP.Enabled }}
    <div class="card-info">
        <h3>SFTP / SSHFS</h3>
        
        <div class="info-group">
            <div class="info-label">SFTP 连接地址</div>
            <div class="code-block">
                <span id="sftp-url">sftp://Loading...</span>
                <button class="copy-btn" onclick="copyToClipboard('sftp-url')">复制</button>
            </div>
        </div>

        <div class="info-group">
            <div class="info-label">SSHFS 挂载命令</div>
            <div class="code-block">
                <span id="sshfs-cmd">sshfs -p PORT user@host:/ ./mnt</span>
                <button class="copy-btn" onclick="copyToClipboard('sshfs-cmd')">复制</button>
            </div>
        </div>
    </div>
    {{end}}

    <div class="footer">
        Powered by WebDAV Server
    </div>
</div>

<script>
    const hostname = location.hostname;

    function copyToClipboard(elementId) {
        const text = document.getElementById(elementId).textContent;
        navigator.clipboard.writeText(text).then(() => {
            const btn = document.querySelector(`button[onclick="copyToClipboard('${elementId}')"]`);
            const originalText = btn.textContent;
            btn.textContent = '已复制!';
            setTimeout(() => btn.textContent = originalText, 2000);
        });
    }

    {{if .Config.Webdav.Enabled }}
    const webdavUrl = `${location.protocol}//${location.host}{{ .Config.Webdav.Prefix }}`;
    document.getElementById("webdav-url").textContent = webdavUrl;
    {{end}}

    {{if .Config.SFTP.Enabled }}
    // Parse SFTP port from bind address (e.g., ":8022" or "0.0.0.0:8022")
    let sftpPort = "{{ .Config.SFTP.Bind }}";
    const portMatch = sftpPort.match(/:(\d+)$/);
    if (portMatch) {
        sftpPort = portMatch[1];
    } else {
        sftpPort = "22"; // Fallback default
    }

    let sftpUrl = "";
    let sshfsCmd = "";

    if (sftpPort === "22") {
        sftpUrl = `sftp://${hostname}`;
        sshfsCmd = `sshfs {{ .User }}@${hostname}:/ ./mnt`;
    } else {
        sftpUrl = `sftp://${hostname}:${sftpPort}`;
        sshfsCmd = `sshfs -p ${sftpPort} {{ .User }}@${hostname}:/ ./mnt`;
    }

    document.getElementById("sftp-url").textContent = sftpUrl;
    document.getElementById("sshfs-cmd").textContent = sshfsCmd;
    {{end}}
</script>

</body>
</html>