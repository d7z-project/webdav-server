<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>/{{ .Path }}</title>
    <style>
        :root {
            /* Sakura Theme - Light Mode */
            --c-primary: #ff85a2;      /* Vivid Sakura Pink */
            --c-primary-hover: #ff6f91;
            --c-danger: #e02446;       /* Deep Red for contrast */
            --c-bg: #fff0f5;           /* Lavender Blush Background */
            --c-bg-gradient: linear-gradient(135deg, #fff0f5 0%, #ffe4e1 100%);
            --c-card: #ffffff;
            --c-text: #594a4e;         /* Warm Dark Gray */
            --c-sub: #9e8fa2;          /* Muted Purple-Gray */
            --c-border: #f3d1dc;       /* Pale Pink Border */
            --c-hover: #fff5f8;        /* Very Pale Pink Hover */
            --c-th: #ffeaf0;           /* Light Pink Header Background */
            --c-mask: rgba(255, 240, 245, 0.85);
            --c-mask-dark: rgba(89, 74, 78, 0.4);
            --shadow-card: 0 4px 20px rgba(255, 133, 162, 0.15);
            --radius-lg: 16px;
            --radius-md: 10px;
            --radius-sm: 6px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* Sakura Theme - Dark Mode */
                --c-primary: #ff9eb5;      /* Light Sakura Pink */
                --c-primary-hover: #ffb6c1;
                --c-danger: #ff6b81;
                --c-bg: #2a2125;           /* Deep Warm Dark */
                --c-bg-gradient: linear-gradient(135deg, #2a2125 0%, #1f181b 100%);
                --c-card: #362b30;         /* Dark Plum Card */
                --c-text: #fcecef;         /* Pale Pink Text */
                --c-sub: #bbaab3;
                --c-border: #4d3d44;
                --c-hover: #403238;
                --c-th: #403238;
                --c-mask: rgba(42, 33, 37, 0.9);
                --c-mask-dark: rgba(0, 0, 0, 0.6);
                --shadow-card: 0 8px 24px rgba(0, 0, 0, 0.3);
            }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        body { 
            background: var(--c-bg);
            background-image: var(--c-bg-gradient);
            color: var(--c-text); 
            padding: 40px 20px; 
            max-width: 1200px; 
            margin: 0 auto; 
            min-height: 100vh; 
            font-size: 15px; 
            line-height: 1.6;
        }
        
        a { text-decoration: none; color: inherit; transition: color 0.2s; }
        button { font-family: inherit; }

        /* Header */
        .header {
            background: var(--c-card);
            padding: 20px 28px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--c-border);
            flex-wrap: wrap;
            gap: 16px;
            box-shadow: var(--shadow-card);
        }

        .nav { font-size: 18px; font-weight: 600; color: var(--c-text); letter-spacing: -0.5px; }
        .nav a:hover { color: var(--c-primary); }
        .nav span { color: var(--c-sub); margin: 0 8px; font-weight: 400; }

        .actions { display: flex; align-items: center; gap: 16px; }
        .user-tag { 
            font-size: 14px; 
            color: var(--c-sub); 
            background: var(--c-hover); 
            padding: 6px 14px; 
            border-radius: 20px; 
            border: 1px solid var(--c-border);
        }
        .user-tag b { color: var(--c-text); font-weight: 600; }

        /* Buttons */
        .btn {
            background: var(--c-primary);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 6px rgba(255, 133, 162, 0.25);
        }
        .btn:hover { background: var(--c-primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 133, 162, 0.4); }
        .btn:active { transform: translateY(0); box-shadow: 0 2px 4px rgba(255, 133, 162, 0.2); }
        
        .btn-sub { 
            background: transparent; 
            color: var(--c-primary); 
            border: 1.5px solid var(--c-primary); 
            box-shadow: none;
        }
        .btn-sub:hover { background: var(--c-primary); color: #fff; box-shadow: 0 4px 12px rgba(255, 133, 162, 0.3); }
        
        .btn-danger { 
            background: var(--c-danger); 
            color: #fff; 
            box-shadow: 0 2px 6px rgba(224, 36, 70, 0.25);
        }
        .btn-danger:hover { 
            background: var(--c-danger); 
            opacity: 0.9;
            box-shadow: 0 4px 12px rgba(224, 36, 70, 0.4); 
        }
        
        .btn-sub.btn-danger {
            background: transparent;
            color: var(--c-danger);
            border: 1.5px solid var(--c-danger);
            box-shadow: none;
        }
        .btn-sub.btn-danger:hover {
            background: var(--c-danger);
            color: #fff;
        }
        
        .btn-sm { padding: 6px 12px; font-size: 13px; border-radius: var(--radius-sm); }

        /* List */
        .list-wrap {
            background: var(--c-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--c-border);
            box-shadow: var(--shadow-card);
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th {
            text-align: left;
            padding: 18px 24px;
            background: var(--c-th);
            color: var(--c-sub);
            font-weight: 700;
            border-bottom: 1px solid var(--c-border);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        td { padding: 16px 24px; border-bottom: 1px solid var(--c-border); transition: background 0.2s; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: var(--c-hover); cursor: pointer; }

        .name-col { display: flex; align-items: center; gap: 14px; }
        .name-col a { flex: 1; word-break: break-all; font-weight: 500; font-size: 15px; }
        tr:hover .name-col a { color: var(--c-primary); }

        .meta { color: var(--c-sub); font-family: "SF Mono", "Menlo", "Monaco", "Courier New", monospace; font-size: 13px; white-space: nowrap; }
        
        /* Icons */
        .ico { width: 24px; height: 24px; background-size: contain; background-repeat: no-repeat; flex-shrink: 0; opacity: 0.8; transition: opacity 0.2s; }
        tr:hover .ico { opacity: 1; }
        .i-dir { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fbc02d'%3E%3Cpath d='M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z'/%3E%3C/svg%3E"); }
        .i-file { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239e9e9e'%3E%3Cpath d='M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6z'/%3E%3C/svg%3E"); }
        .i-up { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ff85a2'%3E%3Cpath d='M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z'/%3E%3C/svg%3E"); }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--c-mask-dark);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(4px);
        }
        .modal.show { display: flex; opacity: 1; }
        
        .modal-card {
            background: var(--c-card);
            padding: 32px;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid var(--c-border);
        }
        .modal.show .modal-card { transform: scale(1); }

        .modal-title { margin-bottom: 20px; font-size: 20px; font-weight: 700; color: var(--c-text); text-align: center; }
        .modal-body { margin-bottom: 24px; font-size: 15px; color: var(--c-text); line-height: 1.6; text-align: center; }
        
        .modal-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--c-border);
            border-radius: var(--radius-md);
            background: var(--c-bg);
            color: var(--c-text);
            font-size: 15px;
            outline: none;
            transition: all 0.2s;
        }
        .modal-input:focus { border-color: var(--c-primary); background: var(--c-card); box-shadow: 0 0 0 4px rgba(255, 133, 162, 0.15); }
        
        .modal-actions { display: flex; justify-content: center; gap: 16px; margin-top: 28px; }
        .modal-actions .btn { min-width: 100px; }

        /* Drag Overlay */
        #drag-mask {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--c-mask);
            z-index: 900;
            color: var(--c-primary);
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: 800;
            backdrop-filter: blur(8px);
            flex-direction: column;
            gap: 20px;
        }
        #drag-mask::after {
            content: "‚òÅÔ∏è";
            font-size: 64px;
            animation: bounce 1s infinite alternate;
        }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }

        /* Progress Bar */
        .progress-bar-bg { background: var(--c-hover); height: 8px; border-radius: 4px; overflow: hidden; margin-top: 12px; border: 1px solid var(--c-border); }
        .progress-bar-fill { height: 100%; background: var(--c-primary); width: 0%; transition: width 0.3s ease-out; background-image: linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent); background-size: 1rem 1rem; }
        .progress-text { margin-top: 8px; font-size: 13px; color: var(--c-sub); text-align: right; font-weight: 500; }

        /* Toast */
        #toast {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--c-card);
            color: var(--c-text);
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 15px;
            font-weight: 500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border: 1px solid var(--c-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(0); }
        #toast::before { content: "üå∏"; font-size: 18px; }

        @media (max-width: 600px) {
            .meta { display: none; }
            body { padding: 16px 12px; }
            .header { padding: 16px; gap: 12px; }
            .nav { font-size: 16px; }
            .actions { width: 100%; justify-content: space-between; border-top: 1px solid var(--c-border); padding-top: 16px; margin-top: 8px; }
            td, th { padding: 14px 16px; }
            .btn-sm { padding: 8px 14px; }
        }
    </style>
</head>
<body>

<div id="drag-mask">ÈáäÊîæÊñá‰ª∂‰ª•‰∏ä‰º†</div>
<div id="toast"></div>

<!-- ÈÄöÁî®ËæìÂÖ•ÂºπÁ™ó (Êñ∞Âª∫Êñá‰ª∂Â§π/ÈáçÂëΩÂêç) -->
<div id="input-modal" class="modal">
    <div class="modal-card">
        <h3 class="modal-title" id="input-title">Ê†áÈ¢ò</h3>
        <input type="text" id="input-val" class="modal-input" autocomplete="off">
        <div class="modal-actions" style="margin-top: 20px;">
            <button class="btn btn-sub" onclick="closeModal('input-modal')">ÂèñÊ∂à</button>
            <button class="btn" id="input-confirm">Á°ÆÂÆö</button>
        </div>
    </div>
</div>

<!-- Á°ÆËÆ§ÂºπÁ™ó (Âà†Èô§) -->
<div id="confirm-modal" class="modal">
    <div class="modal-card">
        <h3 class="modal-title">Á°ÆËÆ§Êìç‰Ωú</h3>
        <div class="modal-body" id="confirm-msg">Á°ÆÂÆöË¶ÅÊâßË°åÊ≠§Êìç‰ΩúÂêóÔºü</div>
        <div class="modal-actions">
            <button class="btn btn-sub" onclick="closeModal('confirm-modal')">ÂèñÊ∂à</button>
            <button class="btn btn-danger" id="confirm-btn">Âà†Èô§</button>
        </div>
    </div>
</div>

<!-- ‰∏ä‰º†ËøõÂ∫¶ÂºπÁ™ó -->
<div id="progress-modal" class="modal">
    <div class="modal-card">
        <h3 class="modal-title">Ê≠£Âú®‰∏ä‰º†</h3>
        <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="p-bar"></div>
        </div>
        <div class="progress-text" id="p-txt">0%</div>
    </div>
</div>

<input type="file" id="f-input" style="display:none">

<div class="header">
    <div class="nav">
        <a href="/">È¶ñÈ°µ</a>
        {{ $pathParts := split .Path "/" }}{{ $cp := "" }}
        {{ range $part := $pathParts }}{{ if $part }}
            <span>/</span>{{ $cp = printf "%s/%s" $cp $part }}<a href="{{ $cp }}">{{ $part }}</a>
        {{ end }}{{ end }}
    </div>

    <div class="actions">
        <span class="user-tag">Áî®Êà∑: <b>{{ .User }}</b></span>
        {{ if .IsGuest }}
        <a href="/?login=true&return=/preview/{{ .Path }}" class="btn">ÁôªÂΩï</a>
        {{ else }}
        <button class="btn btn-sub" onclick="openMkdir()">+ Êñá‰ª∂Â§π</button>
        <button class="btn" onclick="document.getElementById('f-input').click()">+ ‰∏ä‰º†</button>
        {{ end }}
    </div>
</div>

<div class="list-wrap">
    <table>
        <thead>
        <tr>
            <th>Êñá‰ª∂Âêç</th>
            <th width="120" class="meta">Â§ßÂ∞è</th>
            <th width="180" class="meta">Êó∂Èó¥</th>
            {{ if not $.IsGuest }}<th width="140" class="meta">Êìç‰Ωú</th>{{ end }}
        </tr>
        </thead>
        <tbody>
        {{ if ne .Path "" }}
            <tr onclick="location.href='../'">
                <td><div class="name-col"><i class="ico i-up"></i><a href="../">‰∏äÁ∫ßÁõÆÂΩï</a></div></td>
                <td class="meta">-</td>
                <td class="meta">-</td>
                {{ if not $.IsGuest }}<td class="meta"></td>{{ end }}
            </tr>
        {{ end }}
        {{ range .Dirs }}
            <tr data-url="{{if .IsDir}}./{{.Name}}/{{else}}./{{.Name}}{{end}}">
                <td>
                    <div class="name-col">
                        <i class="ico {{if .IsDir}}i-dir{{else}}i-file{{end}}"></i>
                        <a href="{{if .IsDir}}./{{.Name}}/{{else}}./{{.Name}}{{end}}">{{.Name}}</a>
                    </div>
                </td>
                <td class="meta">{{if .IsDir}}-{{else}}{{ Bytesize .Size }}{{end}}</td>
                <td class="meta">{{ .ModTime.Format "2006-01-02 15:04" }}</td>
                {{ if not $.IsGuest }}
                <td class="meta" onclick="event.stopPropagation()">
                    <button class="btn btn-sub btn-sm" onclick="openRename('{{.Name}}')">ÈáçÂëΩÂêç</button>
                    <button class="btn btn-sub btn-danger btn-sm" onclick="openDelete('{{.Name}}')">Âà†Èô§</button>
                </td>
                {{ end }}
            </tr>
        {{ end }}
        </tbody>
    </table>
</div>

<script>
    // Â∑•ÂÖ∑ÂáΩÊï∞
    const $ = id => document.getElementById(id);
    const showToast = (msg, duration = 2000) => {
        const t = $('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), duration);
    };
    
    // ÂºπÁ™óÊéßÂà∂
    const openModal = (id) => {
        const m = $(id);
        m.classList.add('show');
        const input = m.querySelector('input');
        if(input) setTimeout(() => input.focus(), 100);
    };
    const closeModal = (id) => $(id).classList.remove('show');

    // ‰∏öÂä°ÈÄªËæë
    let currentPath = location.href;
    
    // Mkdir
    window.openMkdir = () => {
        $('input-title').textContent = "Êñ∞Âª∫Êñá‰ª∂Â§π";
        $('input-val').value = "";
        $('input-confirm').onclick = doMkdir;
        $('input-val').onkeydown = (e) => { if(e.key === 'Enter') doMkdir(); };
        openModal('input-modal');
    };

    const doMkdir = () => {
        const name = $('input-val').value.trim();
        if(!name) return showToast('ËØ∑ËæìÂÖ•ÂêçÁß∞');
        
        req('?mkdir=true', 'name=' + encodeURIComponent(name), () => {
            closeModal('input-modal');
            location.reload();
        });
    };

    // Rename
    window.openRename = (oldName) => {
        $('input-title').textContent = "ÈáçÂëΩÂêç";
        $('input-val').value = oldName;
        $('input-confirm').onclick = () => doRename(oldName);
        $('input-val').onkeydown = (e) => { if(e.key === 'Enter') doRename(oldName); };
        openModal('input-modal');
    };

    const doRename = (oldName) => {
        const newName = $('input-val').value.trim();
        if(!newName || newName === oldName) return closeModal('input-modal');

        req('?rename=true', `oldName=${encodeURIComponent(oldName)}&newName=${encodeURIComponent(newName)}`, () => {
            closeModal('input-modal');
            location.reload();
        });
    };

    // Delete
    window.openDelete = (name) => {
        $('confirm-msg').textContent = `Á°ÆÂÆöË¶ÅÂà†Èô§ "${name}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`;
        $('confirm-btn').onclick = () => doDelete(name);
        openModal('confirm-modal');
    };

    const doDelete = (name) => {
        req('?delete=true', 'name=' + encodeURIComponent(name), () => {
            closeModal('confirm-modal');
            location.reload();
        });
    };

    // AJAX ËØ∑Ê±ÇÂ∞ÅË£Ö
    const req = (url, body, successCb) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', currentPath + url, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.onload = () => {
            if (xhr.status < 300) successCb();
            else showToast('Êìç‰ΩúÂ§±Ë¥•: ' + (xhr.responseText || xhr.statusText));
        };
        xhr.onerror = () => showToast('ÁΩëÁªúÈîôËØØ');
        xhr.send(body);
    };

    // ‰∏ä‰º†ÈÄªËæë
    const handleUpload = (file) => {
        openModal('progress-modal');
        $('p-bar').style.width = '0%';
        $('p-txt').textContent = '0%';

        const xhr = new XMLHttpRequest();
        xhr.open('POST', currentPath, true);
        
        xhr.upload.onprogress = e => {
            if (e.lengthComputable) {
                const pct = Math.round((e.loaded / e.total) * 100) + '%';
                $('p-bar').style.width = pct;
                $('p-txt').textContent = pct;
            }
        };
        
        xhr.onload = () => {
            if (xhr.status < 300) location.reload();
            else {
                showToast('‰∏ä‰º†Â§±Ë¥•: ' + xhr.status);
                closeModal('progress-modal');
            }
        };
        xhr.onerror = () => {
            showToast('ÁΩëÁªúÈîôËØØ');
            closeModal('progress-modal');
        };

        const fd = new FormData();
        fd.append('file', file);
        xhr.send(fd);
        $('f-input').value = '';
    };

    // ÂàùÂßãÂåñ‰∫ã‰ª∂
    document.addEventListener('DOMContentLoaded', () => {
        // ÁÇπÂáªË°åË∑≥ËΩ¨
        document.querySelectorAll('tr[data-url]').forEach(tr => {
            tr.addEventListener('click', e => {
                if (e.target.tagName !== 'A' && e.target.tagName !== 'BUTTON') {
                    location.href = tr.dataset.url;
                }
            });
        });

        // ÊãñÊãΩ‰∏ä‰º†
        const mask = $('drag-mask');
        let dragCount = 0;
        window.addEventListener('dragenter', e => { e.preventDefault(); dragCount++; mask.style.display = 'flex'; });
        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('dragleave', () => { dragCount--; if(dragCount === 0) mask.style.display = 'none'; });
        window.addEventListener('drop', e => {
            e.preventDefault(); dragCount = 0; mask.style.display = 'none';
            if (e.dataTransfer.files.length) handleUpload(e.dataTransfer.files[0]);
        });

        $('f-input').addEventListener('change', function() {
            if (this.files.length) handleUpload(this.files[0]);
        });
        
        // ÁÇπÂáªÈÅÆÁΩ©ÂÖ≥Èó≠ÂºπÁ™ó
        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', e => {
                if(e.target === m) m.classList.remove('show');
            });
        });
    });
</script>
</body>
</html>