<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>/{{ .Path }}</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="layout-full">

<div id="drag-mask">释放文件以上传</div>
<div id="toast"></div>

<!-- 通用输入弹窗 (新建文件夹/重命名) -->
<div id="input-modal" class="modal">
    <div class="modal-card">
        <h3 class="modal-title" id="input-title">标题</h3>
        <input type="text" id="input-val" class="modal-input" autocomplete="off">
        <div class="modal-actions">
            <button class="btn btn-sub" onclick="closeModal('input-modal')">取消</button>
            <button class="btn" id="input-confirm">确定</button>
        </div>
    </div>
</div>

<!-- 确认弹窗 (删除) -->
<div id="confirm-modal" class="modal">
    <div class="modal-card">
        <h3 class="modal-title">确认操作</h3>
        <div class="modal-body" id="confirm-msg">确定要执行此操作吗？</div>
        <div class="modal-actions">
            <button class="btn btn-sub" onclick="closeModal('confirm-modal')">取消</button>
            <button class="btn btn-danger" id="confirm-btn">删除</button>
        </div>
    </div>
</div>

<!-- 上传进度弹窗 -->
<div id="progress-modal" class="modal">
    <div class="modal-card">
        <h3 class="modal-title">正在上传</h3>
        <div class="progress-bar-bg">
            <div class="progress-bar-fill" id="p-bar"></div>
        </div>
        <div class="progress-text" id="p-txt">0%</div>
    </div>
</div>

<input type="file" id="f-input" style="display:none">

<div class="header">
    <div class="nav">
        <a href="/">首页</a>
        {{ $pathParts := split "/" .Path }}{{ $cp := "" }}
        {{ range $part := $pathParts }}{{ if $part }}
            <span>/</span>{{ $cp = printf "%s/%s" $cp $part }}<a href="/preview{{ $cp }}/">{{ $part }}</a>
        {{ end }}{{ end }}
    </div>

    <div class="actions">
        <span class="user-tag">用户: <b>{{ .User }}</b></span>
        {{ if .IsGuest }}
        <a href="/login?return=/preview/{{ .Path }}" class="btn">登录</a>
        {{ else }}
        <button class="btn btn-sub" onclick="openMkdir()">+ 文件夹</button>
        <button class="btn" onclick="document.getElementById('f-input').click()">+ 上传</button>
        {{ end }}
    </div>
</div>

<div class="list-wrap">
    <table>
        <thead>
        <tr>
            <th>文件名</th>
            <th width="120" class="meta">大小</th>
            <th width="180" class="meta">时间</th>
            {{ if not $.IsGuest }}<th width="140" class="meta">操作</th>{{ end }}
        </tr>
        </thead>
        <tbody>
        {{ if ne .Path "" }}
            <tr onclick="location.href='../'">
                <td><div class="name-col"><i class="ico i-up"></i><a href="../">上级目录</a></div></td>
                <td class="meta">-</td>
                <td class="meta">-</td>
                {{ if not $.IsGuest }}<td class="meta"></td>{{ end }}
            </tr>
        {{ end }}
        {{ range .Dirs }}
            <tr data-url="{{if .IsDir}}./{{.Name}}/{{else}}./{{.Name}}{{end}}">
                <td>
                    <div class="name-col">
                        <i class="ico {{if .IsDir}}i-dir{{else}}i-file{{end}}"></i>
                        <a href="{{if .IsDir}}./{{.Name}}/{{else}}./{{.Name}}{{end}}">{{.Name}}</a>
                    </div>
                </td>
                <td class="meta">{{if .IsDir}}-{{else}}{{ Bytesize .Size }}{{end}}</td>
                <td class="meta">{{ .ModTime.Format "2006-01-02 15:04" }}</td>
                {{ if not $.IsGuest }}
                <td class="meta" onclick="event.stopPropagation()">
                    <button class="btn btn-sub btn-sm" onclick="openRename('{{.Name}}')">重命名</button>
                    <button class="btn btn-sub btn-danger btn-sm" onclick="openDelete('{{.Name}}')">删除</button>
                </td>
                {{ end }}
            </tr>
        {{ end }}
        </tbody>
    </table>
</div>

{{ if .Readme }}
<div class="readme-wrap">
    {{ .Readme }}
</div>
{{ end }}

<script>
    // 工具函数
    const $ = id => document.getElementById(id);
    const showToast = (msg, duration = 2000) => {
        const t = $('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), duration);
    };
    
    // 弹窗控制
    const openModal = (id) => {
        const m = $(id);
        m.classList.add('show');
        const input = m.querySelector('input');
        if(input) setTimeout(() => input.focus(), 100);
    };
    const closeModal = (id) => $(id).classList.remove('show');

    // 业务逻辑
    let currentPath = location.href;
    
    // Mkdir
    window.openMkdir = () => {
        $('input-title').textContent = "新建文件夹";
        $('input-val').value = "";
        $('input-confirm').onclick = doMkdir;
        $('input-val').onkeydown = (e) => { if(e.key === 'Enter') doMkdir(); };
        openModal('input-modal');
    };

    const doMkdir = () => {
        const name = $('input-val').value.trim();
        if(!name) return showToast('请输入名称');
        
        req('?mkdir=true', 'name=' + encodeURIComponent(name), () => {
            closeModal('input-modal');
            location.reload();
        });
    };

    // Rename
    window.openRename = (oldName) => {
        $('input-title').textContent = "重命名";
        $('input-val').value = oldName;
        $('input-confirm').onclick = () => doRename(oldName);
        $('input-val').onkeydown = (e) => { if(e.key === 'Enter') doRename(oldName); };
        openModal('input-modal');
    };

    const doRename = (oldName) => {
        const newName = $('input-val').value.trim();
        if(!newName || newName === oldName) return closeModal('input-modal');

        req('?rename=true', `oldName=${encodeURIComponent(oldName)}&newName=${encodeURIComponent(newName)}`, () => {
            closeModal('input-modal');
            location.reload();
        });
    };

    // Delete
    window.openDelete = (name) => {
        $('confirm-msg').textContent = `确定要删除 "${name}" 吗？此操作不可恢复。`;
        $('confirm-btn').onclick = () => doDelete(name);
        openModal('confirm-modal');
    };

    const doDelete = (name) => {
        req('?delete=true', 'name=' + encodeURIComponent(name), () => {
            closeModal('confirm-modal');
            location.reload();
        });
    };

    // AJAX 请求封装
    const req = (url, body, successCb) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', currentPath + url, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.onload = () => {
            if (xhr.status < 300) successCb();
            else showToast('操作失败: ' + (xhr.responseText || xhr.statusText));
        };
        xhr.onerror = () => showToast('网络错误');
        xhr.send(body);
    };

    // 上传逻辑
    const handleUpload = (file) => {
        openModal('progress-modal');
        $('p-bar').style.width = '0%';
        $('p-txt').textContent = '0%';

        const xhr = new XMLHttpRequest();
        xhr.open('POST', currentPath, true);
        
        xhr.upload.onprogress = e => {
            if (e.lengthComputable) {
                const pct = Math.round((e.loaded / e.total) * 100) + '%';
                $('p-bar').style.width = pct;
                $('p-txt').textContent = pct;
            }
        };
        
        xhr.onload = () => {
            if (xhr.status < 300) location.reload();
            else {
                showToast('上传失败: ' + xhr.status);
                closeModal('progress-modal');
            }
        };
        xhr.onerror = () => {
            showToast('网络错误');
            closeModal('progress-modal');
        };

        const fd = new FormData();
        fd.append('file', file);
        xhr.send(fd);
        $('f-input').value = '';
    };

    // 初始化事件
    document.addEventListener('DOMContentLoaded', () => {
        // 点击行跳转
        document.querySelectorAll('tr[data-url]').forEach(tr => {
            tr.addEventListener('click', e => {
                if (e.target.tagName !== 'A' && e.target.tagName !== 'BUTTON') {
                    location.href = tr.dataset.url;
                }
            });
        });

        // 拖拽上传
        const mask = $('drag-mask');
        let dragCount = 0;
        window.addEventListener('dragenter', e => { e.preventDefault(); dragCount++; mask.style.display = 'flex'; });
        window.addEventListener('dragover', e => e.preventDefault());
        window.addEventListener('dragleave', () => { dragCount--; if(dragCount === 0) mask.style.display = 'none'; });
        window.addEventListener('drop', e => {
            e.preventDefault(); dragCount = 0; mask.style.display = 'none';
            if (e.dataTransfer.files.length) handleUpload(e.dataTransfer.files[0]);
        });

        $('f-input').addEventListener('change', function() {
            if (this.files.length) handleUpload(this.files[0]);
        });
        
        // 点击遮罩关闭弹窗
        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', e => {
                if(e.target === m) m.classList.remove('show');
            });
        });
    });
</script>
</body>
</html>